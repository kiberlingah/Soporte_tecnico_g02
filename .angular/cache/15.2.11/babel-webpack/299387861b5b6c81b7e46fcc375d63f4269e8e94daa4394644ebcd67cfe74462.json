{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport Swal from 'sweetalert2';\nlet CitasComponent = class CitasComponent {\n  constructor(modalidadService, distritoService, horarioService, tarifaService, clienteService, citaService, auth) {\n    this.modalidadService = modalidadService;\n    this.distritoService = distritoService;\n    this.horarioService = horarioService;\n    this.tarifaService = tarifaService;\n    this.clienteService = clienteService;\n    this.citaService = citaService;\n    this.auth = auth;\n    this.servicios = [];\n    this.modalidades = [];\n    this.distritos = [];\n    this.horarios = [];\n    this.tarifasDomicilio = [];\n    this.cliente = {};\n    this.nombreCompleto = '';\n    //hoy: string = '';\n    // Estado del formulario\n    this.citas_diagnostico = {\n      id_cliente: '',\n      id_horario: '',\n      fecha_atencion: '',\n      estado: '',\n      id_modalidad: '',\n      id_tarifadomicilio: '',\n      id_distrito: '',\n      direccion: '',\n      comentario_cliente: '',\n      documento: '',\n      id_usuario: '',\n      observacion_tecnico: '',\n      precio_diagnostico: 0,\n      precio_domicilio: 0,\n      acepto: false\n    };\n    this.fechaMinima = '';\n    this.idDistritoSeleccionado = '';\n    this.precioTarifa = 0.00;\n    this.modalidadAnterior = 0;\n  }\n  ngOnInit() {\n    // Fecha \n    const hoy = new Date();\n    const manana = new Date(hoy);\n    manana.setDate(hoy.getDate() + 2);\n    this.fechaMinima = manana.toISOString().split('T')[0];\n    this.citas_diagnostico.fecha_atencion = this.fechaMinima;\n    // listas de modalidades, distritos y horarios\n    this.modalidadService.getModalidades().subscribe({\n      next: d => this.modalidades = d,\n      error: err => console.error('Error al cargar modalidades:', err)\n    });\n    this.distritoService.listar().subscribe({\n      next: d => this.distritos = d,\n      error: err => console.error('Error al cargar distritos:', err)\n    });\n    this.horarioService.listar().subscribe({\n      next: h => this.horarios = h,\n      error: err => console.error('Error al cargar horarios:', err)\n    });\n    this.tarifaService.listar().subscribe({\n      next: t => this.tarifasDomicilio = t,\n      error: err => console.error('Error al cargar tarifas:', err)\n    });\n    const token = localStorage.getItem('token');\n    const idCliente = Number(localStorage.getItem('id_cliente'));\n    if (token && idCliente) {\n      this.clienteService.obtenerCliente(idCliente, token).subscribe({\n        next: data => {\n          this.cliente = data;\n          this.nombreCompleto = `${this.cliente.nombres} ${this.cliente.apellidos}`;\n          this.citas_diagnostico.id_cliente = this.cliente.id_cliente;\n        },\n        error: err => console.error('Error al cargar cliente:', err)\n      });\n    }\n  }\n  validarNoDomingo() {\n    if (!this.citas_diagnostico.fecha_atencion) return;\n    const [year, month, day] = this.citas_diagnostico.fecha_atencion.split('-').map(Number);\n    const fecha = new Date(year, month - 1, day);\n    const diaSemana = fecha.getDay();\n    if (diaSemana === 0) {\n      Swal.fire({\n        title: \"¡Lo sentimos!\",\n        text: \"No atendemos los días domingo. Por favor elija otra fecha.\",\n        imageUrl: \"https://cdn3d.iconscout.com/3d/premium/thumb/sleeping-robot-3d-icon-png-download-11431668.png\",\n        imageWidth: 150,\n        imageHeight: 150,\n        imageAlt: \"Custom image\",\n        confirmButtonText: \"Aceptar\"\n      });\n      this.citas_diagnostico.fecha_atencion = this.fechaMinima;\n    }\n  }\n  validarModalidad() {\n    if (this.citas_diagnostico.id_modalidad != 3) {\n      this.idDistritoSeleccionado = '';\n      this.citas_diagnostico.direccion = '';\n      this.precioTarifa = 0;\n    }\n  }\n  setearTarifaDomicilio() {\n    if (!this.idDistritoSeleccionado) {\n      this.precioTarifa = 0;\n      return;\n    }\n    this.tarifaService.obtenerTarifaDistrito(this.idDistritoSeleccionado).subscribe({\n      next: resp => {\n        this.precioTarifa = parseFloat(resp.precio);\n        console.log(\"Precio obtenido:\", this.precioTarifa);\n      },\n      error: err => {\n        console.error(\"Error obteniendo tarifa:\", err);\n        this.precioTarifa = 0;\n      }\n    });\n  }\n  get tarifaDomicilio() {\n    const n = Number(this.precioTarifa) || 0;\n    return n.toFixed(2);\n  }\n  registrarCitaDiagnostico() {\n    const precioCita = 50.00;\n    const precioDomicilio = this.citas_diagnostico.id_modalidad == 3 ? parseFloat(this.tarifaDomicilio) || 0 : 0;\n    const montoFinal = precioCita + precioDomicilio;\n    const data = {\n      citas_diagnostico: {\n        id_cliente: this.citas_diagnostico.id_cliente,\n        id_horario: this.citas_diagnostico.id_horario,\n        fecha_atencion: this.citas_diagnostico.fecha_atencion,\n        estado: \"Pendiente\",\n        id_modalidad: this.citas_diagnostico.id_modalidad,\n        id_tarifadomicilio: this.citas_diagnostico.id_modalidad == 3 ? this.idDistritoSeleccionado : null,\n        id_distrito: this.citas_diagnostico.id_modalidad == 3 ? this.idDistritoSeleccionado : null,\n        direccion: this.citas_diagnostico.id_modalidad == 3 ? this.citas_diagnostico.direccion : null,\n        documento: this.citas_diagnostico.documento,\n        comentario_cliente: this.citas_diagnostico.comentario_cliente,\n        id_usuario: null,\n        observacion_tecnico: null,\n        precio_diagnostico: precioCita,\n        precio_domicilio: precioDomicilio,\n        acepto: false\n      },\n      pago: {\n        id_tipopago: \"CREDIT_CARD\",\n        fecha_pago: this.obtenerFechaHoraPeru(),\n        monto_final: montoFinal\n      }\n    };\n    console.log(\"Enviando a API:\", data);\n    this.citaService.registrarCitaDiagnostico(data).subscribe({\n      next: resp => {\n        //alert(\"Registro exitoso\");\n        Swal.fire({\n          title: \"¡Registro exitoso!\",\n          icon: \"success\",\n          draggable: true,\n          confirmButtonText: \"Aceptar\"\n        });\n        this.resetFormulario();\n      },\n      error: err => {\n        console.error(\"Error al registrar\", err);\n        //alert(\"Hubo un problema al registrar.\");\n      }\n    });\n  }\n\n  resetFormulario() {\n    this.citas_diagnostico = {\n      id_cliente: this.cliente.id_cliente,\n      documento: \"\",\n      id_modalidad: \"\",\n      fecha_atencion: \"\",\n      id_horario: \"\",\n      direccion: \"\",\n      comentario_cliente: \"\",\n      acepto: false\n    };\n    this.idDistritoSeleccionado = \"\";\n    this.precioTarifa = 0;\n    this.citas_diagnostico.fecha_atencion = this.fechaMinima;\n  }\n  obtenerFechaHoraPeru() {\n    const fecha = new Date();\n    const formateador = new Intl.DateTimeFormat(\"es-PE\", {\n      year: \"numeric\",\n      month: \"2-digit\",\n      day: \"2-digit\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n      second: \"2-digit\",\n      hour12: false,\n      timeZone: \"America/Lima\"\n    });\n    const partes = formateador.formatToParts(fecha);\n    const get = tipo => partes.find(p => p.type === tipo)?.value || \"00\";\n    return `${get(\"year\")}-${get(\"month\")}-${get(\"day\")} ${get(\"hour\")}:${get(\"minute\")}:${get(\"second\")}`;\n  }\n};\nCitasComponent = __decorate([Component({\n  selector: 'app-citas',\n  templateUrl: './citas.component.html',\n  styleUrls: ['./citas.component.scss']\n})], CitasComponent);\nexport { CitasComponent };","map":{"version":3,"mappings":"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","names":["Component","Swal","CitasComponent","constructor","modalidadService","distritoService","horarioService","tarifaService","clienteService","citaService","auth","id_cliente","id_horario","fecha_atencion","estado","id_modalidad","id_tarifadomicilio","id_distrito","direccion","comentario_cliente","documento","id_usuario","observacion_tecnico","precio_diagnostico","precio_domicilio","acepto","ngOnInit","hoy","Date","manana","setDate","getDate","fechaMinima","toISOString","split","citas_diagnostico","getModalidades","subscribe","next","d","modalidades","error","err","console","listar","distritos","h","horarios","t","tarifasDomicilio","token","localStorage","getItem","idCliente","Number","obtenerCliente","data","cliente","nombreCompleto","nombres","apellidos","validarNoDomingo","year","month","day","map","fecha","diaSemana","getDay","fire","title","text","imageUrl","imageWidth","imageHeight","imageAlt","confirmButtonText","validarModalidad","idDistritoSeleccionado","precioTarifa","setearTarifaDomicilio","obtenerTarifaDistrito","resp","parseFloat","precio","log","tarifaDomicilio","n","toFixed","registrarCitaDiagnostico","precioCita","precioDomicilio","montoFinal","pago","id_tipopago","fecha_pago","obtenerFechaHoraPeru","monto_final","icon","draggable","resetFormulario","formateador","Intl","DateTimeFormat","hour","minute","second","hour12","timeZone","partes","formatToParts","get","tipo","find","p","type","value","selector","templateUrl","styleUrls"],"sourceRoot":"","sources":["G:\\FrontendReyshell\\proyecto-web-soporte\\src\\app\\client-portal\\citas\\citas.component.ts"],"sourcesContent":["import { Component, OnInit } from '@angular/core';\r\nimport { AuthService } from 'src/app/auth/auth.service';\r\n\r\n// Servicios que consumen tus APIs Laravel\r\nimport { ModalidadService } from 'src/app/services/modalidad.service';\r\nimport { DistritoService } from 'src/app/services/distrito.service';\r\nimport { HorarioService } from 'src/app/services/horario.service';\r\nimport { ServicioService } from 'src/app/services/servicio.service';\r\nimport { TarifaService } from 'src/app/services/tarifa.service';\r\nimport { ClienteService } from 'src/app/services/cliente.service';\r\nimport { CitaService } from 'src/app/services/cita.service';\r\nimport Swal from 'sweetalert2';\r\n\r\n@Component({\r\n  selector: 'app-citas',\r\n  templateUrl: './citas.component.html',\r\n  styleUrls: ['./citas.component.scss']\r\n})\r\nexport class CitasComponent implements OnInit {\r\n  servicios: any[] = [];\r\n  modalidades: any[] = [];\r\n  distritos: any[] = [];\r\n  horarios: any[] = [];\r\n  tarifasDomicilio: any[] = [];\r\n  cliente: any = {};\r\n  nombreCompleto: string = '';\r\n  //hoy: string = '';\r\n\r\n  // Estado del formulario\r\n  citas_diagnostico:any = {\r\n    id_cliente: '',\r\n    id_horario: '',\r\n    fecha_atencion: '',\r\n    estado: '',\r\n    id_modalidad: '',\r\n    id_tarifadomicilio: '',\r\n    id_distrito: '',\r\n    direccion: '',\r\n    comentario_cliente: '',\r\n    documento: '',\r\n    id_usuario: '',\r\n    observacion_tecnico: '',\r\n    precio_diagnostico: 0,\r\n    precio_domicilio: 0,\r\n    acepto: false\r\n  };\r\n\r\n\r\n  fechaMinima: string = '';\r\n  idDistritoSeleccionado: any = '';\r\n  precioTarifa: number = 0.00;\r\n  modalidadAnterior: number = 0;\r\n\r\n  constructor(\r\n    private modalidadService: ModalidadService,\r\n    private distritoService: DistritoService,\r\n    private horarioService: HorarioService,\r\n    private tarifaService: TarifaService,\r\n    private clienteService: ClienteService,\r\n    private citaService: CitaService,\r\n    public auth: AuthService\r\n  ) { }\r\n\r\n  ngOnInit(): void {\r\n    // Fecha \r\n    const hoy = new Date();\r\n    const manana = new Date(hoy);\r\n    manana.setDate(hoy.getDate() + 2);\r\n    this.fechaMinima = manana.toISOString().split('T')[0];\r\n    this.citas_diagnostico.fecha_atencion = this.fechaMinima;\r\n\r\n    // listas de modalidades, distritos y horarios\r\n    this.modalidadService.getModalidades().subscribe({\r\n      next: (d: any[]) => this.modalidades = d,\r\n      error: (err: any) => console.error('Error al cargar modalidades:', err)\r\n    });\r\n    this.distritoService.listar().subscribe({\r\n      next: (d: any[]) => this.distritos = d,\r\n      error: (err: any) => console.error('Error al cargar distritos:', err)\r\n    });\r\n    this.horarioService.listar().subscribe({\r\n      next: (h: any[]) => this.horarios = h,\r\n      error: (err: any) => console.error('Error al cargar horarios:', err)\r\n    });\r\n    this.tarifaService.listar().subscribe({\r\n      next: (t: any[]) => this.tarifasDomicilio = t,\r\n      error: (err: any) => console.error('Error al cargar tarifas:', err)\r\n    });\r\n\r\n    const token = localStorage.getItem('token');\r\n    const idCliente = Number(localStorage.getItem('id_cliente'));\r\n\r\n    if (token && idCliente) {\r\n      this.clienteService.obtenerCliente(idCliente, token).subscribe({\r\n        next: data => {\r\n          this.cliente = data;\r\n          this.nombreCompleto = `${this.cliente.nombres} ${this.cliente.apellidos}`;\r\n          this.citas_diagnostico.id_cliente = this.cliente.id_cliente;\r\n        },\r\n        error: err => console.error('Error al cargar cliente:', err)\r\n      });\r\n    }\r\n  }\r\n\r\n  validarNoDomingo() {\r\n    if (!this.citas_diagnostico.fecha_atencion) return;\r\n\r\n    const [year, month, day] = this.citas_diagnostico.fecha_atencion.split('-').map(Number);\r\n    const fecha = new Date(year, month - 1, day);\r\n    const diaSemana = fecha.getDay();\r\n\r\n    if (diaSemana === 0) {\r\n      Swal.fire({\r\n        title: \"¡Lo sentimos!\",\r\n        text: \"No atendemos los días domingo. Por favor elija otra fecha.\",\r\n        imageUrl: \"https://cdn3d.iconscout.com/3d/premium/thumb/sleeping-robot-3d-icon-png-download-11431668.png\",\r\n        imageWidth: 150,\r\n        imageHeight: 150,\r\n        imageAlt: \"Custom image\",\r\n        confirmButtonText: \"Aceptar\",\r\n      })\r\n        ;\r\n      this.citas_diagnostico.fecha_atencion = this.fechaMinima;\r\n    }\r\n  }\r\n\r\n  validarModalidad() {\r\n    if (this.citas_diagnostico.id_modalidad != 3) {\r\n      this.idDistritoSeleccionado = '';\r\n      this.citas_diagnostico.direccion = '';\r\n      this.precioTarifa = 0;\r\n    }\r\n  }\r\n\r\n  setearTarifaDomicilio(): void {\r\n    if (!this.idDistritoSeleccionado) {\r\n      this.precioTarifa = 0;\r\n      return;\r\n    }\r\n    this.tarifaService.obtenerTarifaDistrito(this.idDistritoSeleccionado)\r\n      .subscribe({\r\n        next: (resp) => {\r\n          this.precioTarifa = parseFloat(resp.precio);\r\n          console.log(\"Precio obtenido:\", this.precioTarifa);\r\n        },\r\n        error: (err) => {\r\n          console.error(\"Error obteniendo tarifa:\", err);\r\n          this.precioTarifa = 0;\r\n        }\r\n      }\r\n      );\r\n  }\r\n\r\n  get tarifaDomicilio(): string {\r\n    const n = Number(this.precioTarifa) || 0;\r\n    return n.toFixed(2);\r\n  }\r\n\r\n\r\n  registrarCitaDiagnostico() {\r\n    const precioCita = 50.00;\r\n    const precioDomicilio = this.citas_diagnostico.id_modalidad == 3\r\n      ? parseFloat(this.tarifaDomicilio) || 0\r\n      : 0;\r\n\r\n\r\n    const montoFinal = precioCita + precioDomicilio;\r\n\r\n    const data = {\r\n      citas_diagnostico: {\r\n        id_cliente: this.citas_diagnostico.id_cliente,\r\n        id_horario: this.citas_diagnostico.id_horario,\r\n        fecha_atencion: this.citas_diagnostico.fecha_atencion,\r\n        estado: \"Pendiente\",\r\n        id_modalidad: this.citas_diagnostico.id_modalidad,\r\n        id_tarifadomicilio:\r\n          this.citas_diagnostico.id_modalidad == 3 ? this.idDistritoSeleccionado : null,\r\n        id_distrito:\r\n          this.citas_diagnostico.id_modalidad == 3 ? this.idDistritoSeleccionado : null,\r\n        direccion:\r\n          this.citas_diagnostico.id_modalidad == 3 ? this.citas_diagnostico.direccion : null,\r\n        documento: this.citas_diagnostico.documento,\r\n        comentario_cliente: this.citas_diagnostico.comentario_cliente,\r\n        id_usuario: null,\r\n        observacion_tecnico: null,\r\n        precio_diagnostico: precioCita,\r\n        precio_domicilio: precioDomicilio,\r\n        acepto: false\r\n      },\r\n      pago: {\r\n        id_tipopago: \"CREDIT_CARD\",\r\n        fecha_pago: this.obtenerFechaHoraPeru(),\r\n        monto_final: montoFinal,\r\n      },\r\n    };\r\n\r\n    console.log(\"Enviando a API:\", data);\r\n\r\n    this.citaService.registrarCitaDiagnostico(data).subscribe({\r\n      next: (resp) => {\r\n        //alert(\"Registro exitoso\");\r\n        Swal.fire({\r\n          title: \"¡Registro exitoso!\",\r\n          icon: \"success\",\r\n          draggable: true,\r\n          confirmButtonText: \"Aceptar\",\r\n        });\r\n        this.resetFormulario();\r\n      },\r\n      error: (err) => {\r\n        console.error(\"Error al registrar\", err);\r\n        //alert(\"Hubo un problema al registrar.\");\r\n      }\r\n    });\r\n  }\r\n\r\n\r\n\r\n  resetFormulario() {\r\n    this.citas_diagnostico = {\r\n      id_cliente: this.cliente.id_cliente,\r\n      documento: \"\",\r\n      id_modalidad: \"\",\r\n      fecha_atencion: \"\",\r\n      id_horario: \"\",\r\n      direccion: \"\",\r\n      comentario_cliente: \"\",\r\n      acepto: false\r\n    };\r\n    this.idDistritoSeleccionado = \"\";\r\n    this.precioTarifa = 0;\r\n\r\n\r\n    this.citas_diagnostico.fecha_atencion = this.fechaMinima;\r\n  }\r\n\r\n  obtenerFechaHoraPeru(): string {\r\n    const fecha = new Date();\r\n    const formateador = new Intl.DateTimeFormat(\"es-PE\", {\r\n      year: \"numeric\",\r\n      month: \"2-digit\",\r\n      day: \"2-digit\",\r\n      hour: \"2-digit\",\r\n      minute: \"2-digit\",\r\n      second: \"2-digit\",\r\n      hour12: false,\r\n      timeZone: \"America/Lima\"\r\n    });\r\n\r\n    const partes = formateador.formatToParts(fecha);\r\n\r\n    const get = (tipo: string) =>\r\n      partes.find(p => p.type === tipo)?.value || \"00\";\r\n\r\n    return `${get(\"year\")}-${get(\"month\")}-${get(\"day\")} ${get(\"hour\")}:${get(\"minute\")}:${get(\"second\")}`;\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}